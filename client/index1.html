<!doctype html>
<html>
<meta charset="UTF-8" />
<title>Slime Soccer</title>
</head>
<body>
  <section>
    <div>
      <canvas id="canvas" height="600" width="1400" style="position: absolute;display:block;margin:20px auto;border:1px solid #666;">
        Get a better browser!</canvas>
      <canvas id="myCanvas" height="600" width="1400" style="position: absolute;margin:21px auto;"></canvas>
    </div>
    <script type="text/javascript">
      var WIDTH = 1400;
      var HEIGHT = 600;
      var canvas = ctx = ui= false;
      var frameRate = 1/50; // Seconds
      var frameDelay = frameRate * 1000; // ms
      var loopTimer = false;
      var dx = 10;
      var dy = 5;

      /*
      * Experiment with values of mass, radius, restitution,
      * gravity (ag), and density (rho)!
      *
      * Changing the constants literally changes the environment
      * the ball is in.
      *
      * Some settings to try:
      * the moon: ag = 1.6
      * water: rho = 1000, mass 5
      * beach ball: mass 0.05, radius 30
      * lead ball: mass 10, restitution -0.05
      * slime ball: mass .1, radius 15, restitution -.9
      */
      var ball = {
        position: {x: WIDTH/2, y: 15},
        velocity: {x: 100, y: 0},
        mass: 0.1, //kg
        radius: 15, // 1px = 1cm
        restitution: -.9
      };
      var player = {
        position: {x: 140, y: HEIGHT},
        velocity: {x: 0, y: 0},
        mass: 5,
        radius: 55,
        restitution: 0
      }


      var Cd = 0.47;  // Dimensionless
      var rho = 1.22; // kg / m^3
      var A = Math.PI * ball.radius * ball.radius / (10000); // m^2
      var ag = 9.81;  // m / s^2
      var mouse = {x: 0, y: 0, isDown: false};

      var setup = function() {

        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        myCanvas = document.getElementById("myCanvas");
        ctxUi = myCanvas.getContext("2d");

        ctx.fillStyle = 'red';

        loopTimer = setInterval(loop, frameDelay);
      }
      var loop = function() {
        // Do physics
        // Drag force: Fd = -1/2 * Cd * A * rho * v * v
        var Fx = -0.5 * Cd * A * rho * ball.velocity.x * ball.velocity.x * ball.velocity.x / Math.abs(ball.velocity.x);
        var Fy = -0.5 * Cd * A * rho * ball.velocity.y * ball.velocity.y * ball.velocity.y / Math.abs(ball.velocity.y);

        Fx = (isNaN(Fx) ? 0 : Fx);
        Fy = (isNaN(Fy) ? 0 : Fy);

        // Calculate acceleration ( F = ma )
        var ax = Fx / ball.mass;
        var ay = ag + (Fy / ball.mass);
        // Integrate to get velocity
        ball.velocity.x += ax*frameRate;
        ball.velocity.y += ay*frameRate;

        // Integrate to get position
        ball.position.x += ball.velocity.x*frameRate*100;
        ball.position.y += ball.velocity.y*frameRate*100;

        // Handle collisions
        if (ball.position.y > HEIGHT - ball.radius) {
            // Ball hits floor
            ball.velocity.y *= ball.restitution;
            ball.position.y = HEIGHT - ball.radius;
        }
        if (ball.position.y < ball.radius){
            // Ball hits ceiling
            ball.velocity.y *= ball.restitution;
            ball.position.y = ball.radius;
        }
        if (ball.position.x > WIDTH - ball.radius) {
            // Ball hits right wall
            ball.velocity.x *= ball.restitution;
            ball.position.x = WIDTH - ball.radius;
        }
        if (ball.position.x < ball.radius) {
            // Ball hits left wall
            ball.velocity.x *= ball.restitution;
            ball.position.x = ball.radius;
        }
        // Move player
        while(document.onkeydown = function(event){
      		if(event.keyCode === 65)	//a
      			if(player.position.x - dx > player.radius)
              player.position.x -= dx;
          if(event.keyCode === 68) //d
            if (player.position.x + dx < WIDTH - player.radius)
              player.position.x += dx;
      		// if(event.keyCode === 83)	//s
          //   if (player.position.y + dy < HEIGHT)
          //     player.position.y -= dy;
      		// if(event.keyCode === 87) // w
          //   if (player.position.y - dy > player.radius)
          //     player.position.y += dy;
        // Draw player and ball
      	}
        drawBall();
        drawPlayer();

      }
      function drawBall(){
        ctx.clearRect(0,0,WIDTH,HEIGHT);
        ctx.save();
        ctx.translate(ball.position.x, ball.position.y);
        ctx.beginPath();
        ctx.arc(0, 0, ball.radius, 0, Math.PI*2, true);
        ctx.fill();
        ctx.closePath();
        ctx.restore();
      }
      function drawPlayer(){
        // console.log(player.position.x);
        ctxUi.clearRect(0,0,WIDTH,HEIGHT);
        ctxUi.save();
        ctxUi.beginPath();
        ctxUi.arc(player.position.x, player.position.y, player.radius, 0, Math.PI, true);
        ctxUi.closePath();
        ctxUi.lineWidth = 5;
        ctxUi.fillStyle = 'blue';
        ctxUi.fill();
        ctxUi.strokeStyle = 'blue';
        ctxUi.stroke();
        // console.log(player.position.x);
      }
      setup();
      socket.on('newPositions',function(data){
          ctx.clearRect(0,0,500,500);
          for(var i = 0 ; i < data.length; i++){
              ctxUi.clearRect(0,0,WIDTH,HEIGHT);
              drawPlayer(data[i].x,data[i].y);
          }
      });

        setup();
    </script>
  </section>
</body>
</html>
