<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Slime Soccer</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script>
    $(document).ready(function(){
        $("p").fadeOut(6000);
    });
  </script>
</head>
<body>
  <section>
    <div id="gameDiv">
    	<div id="game">
        <canvas id="ctx" width="1400" height="600" style="position: absolute;display:block; auto;border:1px solid #666;">
          Get a better browser!</canvas>
        <canvas id="ctx-ui" width="1400" height="600" style="position: absolute;display:block; auto;border:1px solid #666;"></canvas>
        <!-- <p style="font-size: 50px;margin: 300px 700px 300px 650px; position: absolute;">PLAY!</p> -->
      </div>
      <!-- <div id="belowGame">
		    <div id="chat-text">
			    <div>Hello! This game is more fun with friends!</div>
		    </div>

		    <form id="chat-form">
			    <input id="chat-input" type="text" placeholder="Type here to chat!"></input>
		    </form>
	    </div> -->
    </div>
    <!-- <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script> -->
    <script src="/client/socket.js"></script>
    <script>
    //
    var WIDTH = 1400;
    var HEIGHT = 600;
    var canvas = ctx = false;
    var frameRate = 1/40; // Seconds
    var frameDelay = frameRate * 1000; // ms
    var loopTimer = false;
    var socket = io();

    // chat
    // var chatText = document.getElementById('chat-text');
  	// var chatInput = document.getElementById('chat-input');
  	// var chatForm = document.getElementById('chat-form');
    //
  	// socket.on('addToChat',function(data){
  	// 	chatText.innerHTML += '<div>' + data + '</div>';
  	// });
  	// socket.on('evalAnswer',function(data){
  	// 	console.log(data);
  	// });
    //
    //
  	// chatForm.onsubmit = function(e){
  	// 	e.preventDefault();
  	// 	if(chatInput.value[0] === '/')
  	// 		socket.emit('evalServer',chatInput.value.slice(1));
  	// 	else{
  	// 		socket.emit('sendMsgToServer',{value:chatInput.value,name:username,});
  	// 	}
  	// 	chatInput.value = '';
  	// }

    //game
    var ball = {
      position: {x: WIDTH/2, y: 15},
      velocity: {x: 20, y: 0},
      mass: 0.1, //kg
      radius: 15, // 1px = 1cm
      restitution: -1,
      };

    var Cd = 0.47;  // Dimensionless
    var rho = 1.22; // kg / m^3
    var A = Math.PI * ball.radius * ball.radius / (10000); // m^2
    var ag = 9.81;  // m / s^2
    var mouse = {x: 0, y: 0, isDown: false};

    ctx = document.getElementById("ctx").getContext("2d");
    ctxUi = document.getElementById("ctx-ui").getContext("2d");

    var Player = function(initPack){
  		var self = {};
  		self.id = initPack.id;
  		self.x = initPack.x;
  		self.y = initPack.y;
  		self.score = initPack.score;

      self.draw = function(){
        ctxUi.clearRect(0,0,WIDTH,HEIGHT);
  			// var x = self.x - Player.list[selfId].x + WIDTH/2;
  			// var y = self.y - Player.list[selfId].y + HEIGHT/2;
        var x = self.x
        var y = self.y
  		  drawPlayer(x,y);
		}
    Player.list[self.id] = self;

		return self;
    }
    Player.list = {};

    var selfId = null;

    socket.on('init',function(data){
		if(data.selfId)
			selfId = data.selfId;
		  for(var i = 0 ; i < data.player.length; i++){
			  new Player(data.player[i]);
		  }
	  });
    socket.on('update',function(data){
  		for(var i = 0 ; i < data.player.length; i++){
  			var pack = data.player[i];
  			var p = Player.list[pack.id];
  			if(p){
  				if(pack.x !== undefined)
  					p.x = pack.x;
  				if(pack.y !== undefined)
  					p.y = pack.y;
  				if(pack.score !== undefined)
  					p.score = pack.score;
  			}
  		}
    });

    socket.on('remove',function(data){
  		for(var i = 0 ; i < data.player.length; i++){
  			delete Player.list[data.player[i]];
  		}
  	});

    setInterval(function(){
  		if(!selfId)
        return;
      ballPhysics();
  		drawBall();
  		for(var i in Player.list)
  			Player.list[i].draw();
  	},40);

    var ballPhysics = function(){
      var Fx = -0.5 * Cd * A * rho * ball.velocity.x * ball.velocity.x * ball.velocity.x / Math.abs(ball.velocity.x);
      var Fy = -0.5 * Cd * A * rho * ball.velocity.y * ball.velocity.y * ball.velocity.y / Math.abs(ball.velocity.y);

      Fx = (isNaN(Fx) ? 0 : Fx);
      Fy = (isNaN(Fy) ? 0 : Fy);

      var ax = Fx / ball.mass;
      var ay = ag + (Fy / ball.mass);

      ball.velocity.x += ax*frameRate;
      ball.velocity.y += ay*frameRate;


      ball.position.x += ball.velocity.x*frameRate*100;
      ball.position.y += ball.velocity.y*frameRate*100;

      if (ball.position.y < ball.radius){
          ball.velocity.y *= ball.restitution;
          ball.position.y = ball.radius;
      }
      if (ball.position.y > HEIGHT - ball.radius) {
          ball.velocity.y *= ball.restitution;
          ball.position.y = HEIGHT - ball.radius;
      }
      if (ball.position.x > WIDTH - ball.radius) {
          ball.velocity.x *= ball.restitution;
          ball.position.x = WIDTH - ball.radius;
      }
      if (ball.position.x < ball.radius) {
          ball.velocity.x *= ball.restitution;
          ball.position.x = ball.radius;
      }
    }
    var drawBall = function(){
      ctx.clearRect(0,0,WIDTH,HEIGHT);
      ctx.save();
      ctx.translate(ball.position.x, ball.position.y);
      ctx.beginPath();
      ctx.arc(0, 0, ball.radius, 0, Math.PI*2, true);
      ctx.fillStyle = 'red';
      ctx.fill();
      ctx.closePath();
      ctx.restore();
    }
    var drawPlayer = function(x,y){
      ctxUi.beginPath();
      ctxUi.arc(x, y, 55, 0, Math.PI, true);
      ctxUi.closePath();
      ctxUi.lineWidth = 5;
      ctxUi.fillStyle = 'blue';
      ctxUi.fill();
      ctxUi.strokeStyle = 'blue';
      ctxUi.stroke();
    }

    document.onkeydown = function(event){
        if(event.keyCode === 68)    //d
            socket.emit('keyPress',{inputId:'right',state:true});
        else if(event.keyCode === 65) //a
            socket.emit('keyPress',{inputId:'left',state:true});
        // else if(event.keyCode === 87) // w
        //     socket.emit('keyPress',{inputId: 'jump', state:true});
        else if(event.keyCode === 87) // w
            socket.emit('keyPress',{inputId:'up', state:true});
        else if(event.keyCode === 83)	//s
            socket.emit('keyPress',{inputId:'down', state:true})

    }
    document.onkeyup = function(event){
        if(event.keyCode === 68)    //d
            socket.emit('keyPress',{inputId:'right',state:false});
        else if(event.keyCode === 65) //a
            socket.emit('keyPress',{inputId:'left',state:false});
        // else if(event.keyCode === 87) // w
        //     socket.emit('keyPress',{inputId: 'jump', state:false});
        else if(event.keyCode === 87) // w
            socket.emit('keyPress',{inputId:'up', state:false});
        else if(event.keyCode === 83)	//s
            socket.emit('keyPress',{inputId:'down', state:false})
    }
    </script>
  </section>
</body>
</html>
